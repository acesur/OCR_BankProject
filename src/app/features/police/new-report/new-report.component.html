<div class="new-report-container">
  <!-- Page Header -->
  <div class="page-header">
    <h1 class="page-title">File New Fraud Report</h1>
    <p class="page-description">Report suspicious bank accounts with OCR-powered data extraction and AI risk assessment</p>
  </div>

  <form [formGroup]="reportForm" (ngSubmit)="onSubmit()" class="report-form">
    
    <!-- Account Details Section -->
    <mat-card class="form-section">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>account_balance</mat-icon>
          Account Details
        </mat-card-title>
      </mat-card-header>
      
      <mat-card-content>
        <div class="form-grid">
          <mat-form-field appearance="outline">
            <mat-label>Account Number</mat-label>
            <input matInput formControlName="accountNumber" placeholder="Enter account number" maxlength="18">
            <mat-icon matSuffix>account_box</mat-icon>
            <mat-error>{{ getFieldError('accountNumber') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Account Holder Name</mat-label>
            <input matInput formControlName="accountHolderName" placeholder="Enter account holder name">
            <mat-icon matSuffix>person</mat-icon>
            <mat-error>{{ getFieldError('accountHolderName') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Bank Name</mat-label>
            <mat-select formControlName="bankName">
              <mat-option *ngFor="let bank of banks" [value]="bank">
                {{ bank }}
              </mat-option>
            </mat-select>
            <mat-icon matSuffix>account_balance</mat-icon>
            <mat-error>{{ getFieldError('bankName') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Branch Name</mat-label>
            <input matInput formControlName="branchName" placeholder="Enter branch name">
            <mat-icon matSuffix>business</mat-icon>
            <mat-error>{{ getFieldError('branchName') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>IFSC Code</mat-label>
            <input matInput formControlName="ifscCode" placeholder="e.g., SBIN0001234" style="text-transform: uppercase">
            <mat-icon matSuffix>confirmation_number</mat-icon>
            <mat-error>{{ getFieldError('ifscCode') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Routing Number</mat-label>
            <input matInput formControlName="routingNumber" placeholder="Enter routing number">
            <mat-icon matSuffix>route</mat-icon>
            <mat-error>{{ getFieldError('routingNumber') }}</mat-error>
          </mat-form-field>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Complaint Details Section -->
    <mat-card class="form-section">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>report_problem</mat-icon>
          Complaint Details
        </mat-card-title>
      </mat-card-header>
      
      <mat-card-content>
        <div class="form-grid">
          <mat-form-field appearance="outline">
            <mat-label>FIR/Case Number</mat-label>
            <input matInput formControlName="firNumber" placeholder="Enter FIR number">
            <mat-icon matSuffix>badge</mat-icon>
            <mat-error>{{ getFieldError('firNumber') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Crime Type</mat-label>
            <mat-select formControlName="crimeType">
              <mat-option *ngFor="let crime of crimeTypes" [value]="crime">
                {{ crime }}
              </mat-option>
            </mat-select>
            <mat-icon matSuffix>category</mat-icon>
            <mat-error>{{ getFieldError('crimeType') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Amount Involved (Optional)</mat-label>
            <input matInput type="number" formControlName="amountInvolved" placeholder="Enter amount in rupees">
            <span matTextPrefix>â‚¹ </span>
            <mat-icon matSuffix>currency_rupee</mat-icon>
            <mat-error>{{ getFieldError('amountInvolved') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Description</mat-label>
            <textarea 
              matInput 
              formControlName="description" 
              placeholder="Provide detailed description of the fraud case..."
              rows="4"
              maxlength="2000">
            </textarea>
            <mat-hint align="end">{{ reportForm.get('description')?.value?.length || 0 }}/2000</mat-hint>
            <mat-error>{{ getFieldError('description') }}</mat-error>
          </mat-form-field>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Evidence & OCR Section -->
    <mat-card class="form-section">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>scanner</mat-icon>
          Evidence & OCR Processing
        </mat-card-title>
        <mat-card-subtitle>Upload documents containing bank account details for automatic extraction</mat-card-subtitle>
      </mat-card-header>
      
      <mat-card-content>
        <!-- File Upload Area -->
        <div 
          class="file-upload-area"
          [class.dragover]="isDragOver"
          [class.has-error]="hasOcrError"
          (dragover)="onDragOver($event)"
          (dragleave)="onDragLeave($event)"
          (drop)="onDrop($event)"
          (click)="triggerFileInput()">
          <div class="upload-content">
            <mat-icon class="upload-icon" [color]="hasOcrError ? 'warn' : 'primary'">
              {{ hasOcrError ? 'error' : 'cloud_upload' }}
            </mat-icon>
            <div class="upload-text">
              {{ isDragOver ? 'Drop file here' : 'Click to upload or drag and drop' }}
            </div>
            <div class="upload-subtext">
              {{ hasOcrError ? ocrErrorMessage : 'Supports JPEG, PNG files up to 10MB' }}
            </div>
          </div>
          <input #fileInput type="file" hidden accept=".jpg,.jpeg,.png" (change)="onFileSelected($event)">
        </div>

        <!-- Image Preview -->
        <div *ngIf="previewUrl" class="image-preview">
          <div class="preview-header">
            <h4>Image Preview</h4>
            <button 
              type="button" 
              mat-icon-button 
              color="warn" 
              (click)="removeFile(0)"
              class="remove-preview">
              <mat-icon>close</mat-icon>
            </button>
          </div>
          <img [src]="previewUrl" alt="Uploaded document" class="preview-image">
        </div>

        <!-- Uploaded Files List -->
        <div *ngIf="uploadedFiles.length > 0" class="uploaded-files">
          <div class="uploaded-files-header">
            <h4>Uploaded Files</h4>
            <span class="files-count">{{ uploadedFiles.length }} file(s)</span>
          </div>
          
          <div class="file-list">
            <div *ngFor="let file of uploadedFiles; let i = index" class="file-item">
              <div class="file-info">
                <mat-icon class="file-icon">image</mat-icon>
                <div class="file-details">
                  <span class="file-name">{{ file.name }}</span>
                  <span class="file-size">{{ getFileSize(file.size) }}</span>
                </div>
              </div>
              <button 
                type="button" 
                mat-icon-button 
                color="warn" 
                (click)="removeFile(i)"
                class="remove-button">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </div>
        </div>

        <!-- OCR Processing -->
        <div *ngIf="uploadedFiles.length > 0" class="ocr-processing">
          <div class="ocr-header">
            <h4>OCR Processing</h4>
            <div class="ocr-status">
              <mat-chip [color]="ocrCompleted ? 'primary' : hasOcrError ? 'warn' : 'default'">
                <mat-icon *ngIf="ocrCompleted">check_circle</mat-icon>
                <mat-icon *ngIf="isOcrProcessing">hourglass_empty</mat-icon>
                <mat-icon *ngIf="hasOcrError">error</mat-icon>
                <mat-icon *ngIf="!isOcrProcessing && !ocrCompleted && !hasOcrError">radio_button_unchecked</mat-icon>
                {{ isOcrProcessing ? 'Processing...' : ocrCompleted ? `Completed (${processingTime}s)` : hasOcrError ? 'Failed' : 'Ready' }}
              </mat-chip>
            </div>
          </div>

          <!-- Processing Progress -->
          <div *ngIf="isOcrProcessing" class="processing-indicator">
            <mat-progress-bar mode="indeterminate" color="primary"></mat-progress-bar>
            <p class="processing-text">Extracting bank document information...</p>
          </div>

          <!-- Error Display -->
          <div *ngIf="hasOcrError" class="ocr-error">
            <mat-icon color="warn">error</mat-icon>
            <span>{{ ocrErrorMessage }}</span>
            <button 
              type="button" 
              mat-button 
              color="primary"
              (click)="processOCR()">
              Try Again
            </button>
          </div>

          <div class="ocr-actions" *ngIf="!hasOcrError">
            <button 
              type="button" 
              mat-raised-button 
              color="primary"
              [disabled]="isOcrProcessing || ocrCompleted"
              (click)="processOCR()">
              <mat-icon *ngIf="!isOcrProcessing">scanner</mat-icon>
              <mat-spinner diameter="20" *ngIf="isOcrProcessing" class="button-spinner"></mat-spinner>
              {{ isOcrProcessing ? 'Processing OCR...' : 'Run OCR Extraction' }}
            </button>
          </div>

          <!-- OCR Results -->
          <div *ngIf="ocrResults && ocrCompleted" class="ocr-results">
            <div class="results-header">
              <h4>Extracted Data</h4>
              <div class="results-actions">
                <button 
                  type="button" 
                  mat-icon-button 
                  [matMenuTriggerFor]="exportMenu"
                  matTooltip="Export Results">
                  <mat-icon>download</mat-icon>
                </button>
                <mat-menu #exportMenu="matMenu">
                  <button mat-menu-item (click)="exportAsJson()">
                    <mat-icon>code</mat-icon>
                    Export as JSON
                  </button>
                  <button mat-menu-item (click)="exportAsCsv()">
                    <mat-icon>table_chart</mat-icon>
                    Export as CSV
                  </button>
                </mat-menu>
              </div>
            </div>
            
            <div class="extracted-fields">
              <div class="field-item">
                <div class="field-header">
                  <label>Bank Name:</label>
                  <div class="confidence-indicator">
                    <mat-chip [color]="getConfidenceColor(ocrResults.bankName.confidence)" size="small">
                      {{ getConfidencePercentage(ocrResults.bankName.confidence) }}
                    </mat-chip>
                  </div>
                </div>
                <div class="field-value nepali-text">{{ ocrResults.bankName.value || 'Not detected' }}</div>
                <div class="confidence-text">{{ getConfidenceText(ocrResults.bankName.confidence) }}</div>
              </div>

              <div class="field-item">
                <div class="field-header">
                  <label>Account Holder Name:</label>
                  <div class="confidence-indicator">
                    <mat-chip [color]="getConfidenceColor(ocrResults.accountHolderName.confidence)" size="small">
                      {{ getConfidencePercentage(ocrResults.accountHolderName.confidence) }}
                    </mat-chip>
                  </div>
                </div>
                <div class="field-value nepali-text">{{ ocrResults.accountHolderName.value || 'Not detected' }}</div>
                <div class="confidence-text">{{ getConfidenceText(ocrResults.accountHolderName.confidence) }}</div>
              </div>

              <div class="field-item">
                <div class="field-header">
                  <label>Account Number:</label>
                  <div class="confidence-indicator">
                    <mat-chip [color]="getConfidenceColor(ocrResults.accountNumber.confidence)" size="small">
                      {{ getConfidencePercentage(ocrResults.accountNumber.confidence) }}
                    </mat-chip>
                  </div>
                </div>
                <div class="field-value">{{ ocrResults.accountNumber.value || 'Not detected' }}</div>
                <div class="confidence-text">{{ getConfidenceText(ocrResults.accountNumber.confidence) }}</div>
              </div>

              <div class="field-item">
                <div class="field-header">
                  <label>Routing Number:</label>
                  <div class="confidence-indicator">
                    <mat-chip [color]="getConfidenceColor(ocrResults.routingNumber.confidence)" size="small">
                      {{ getConfidencePercentage(ocrResults.routingNumber.confidence) }}
                    </mat-chip>
                  </div>
                </div>
                <div class="field-value">{{ ocrResults.routingNumber.value || 'Not detected' }}</div>
                <div class="confidence-text">{{ getConfidenceText(ocrResults.routingNumber.confidence) }}</div>
              </div>

              <div class="field-item">
                <div class="field-header">
                  <label>Amount:</label>
                  <div class="confidence-indicator">
                    <mat-chip [color]="getConfidenceColor(ocrResults.amount.confidence)" size="small">
                      {{ getConfidencePercentage(ocrResults.amount.confidence) }}
                    </mat-chip>
                  </div>
                </div>
                <div class="field-value">{{ ocrResults.amount.value || 'Not detected' }}</div>
                <div class="confidence-text">{{ getConfidenceText(ocrResults.amount.confidence) }}</div>
              </div>

              <div class="field-item">
                <div class="field-header">
                  <label>Date:</label>
                  <div class="confidence-indicator">
                    <mat-chip [color]="getConfidenceColor(ocrResults.date.confidence)" size="small">
                      {{ getConfidencePercentage(ocrResults.date.confidence) }}
                    </mat-chip>
                  </div>
                </div>
                <div class="field-value">{{ ocrResults.date.value || 'Not detected' }}</div>
                <div class="confidence-text">{{ getConfidenceText(ocrResults.date.confidence) }}</div>
              </div>
            </div>

            <mat-divider></mat-divider>

            <div class="ocr-actions">
              <button 
                type="button" 
                mat-raised-button 
                color="accent"
                (click)="useExtractedData()">
                <mat-icon>input</mat-icon>
                Use Extracted Data
              </button>
              
              <button 
                type="button" 
                mat-button 
                color="primary"
                (click)="processOCR()">
                <mat-icon>refresh</mat-icon>
                Re-process
              </button>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- ANN Risk Assessment Section -->
    <mat-card *ngIf="annResults || isAnnProcessing" class="form-section risk-assessment">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>psychology</mat-icon>
          AI Risk Assessment
        </mat-card-title>
        <mat-card-subtitle>Artificial Neural Network fraud risk analysis</mat-card-subtitle>
      </mat-card-header>
      
      <mat-card-content>
        <div *ngIf="isAnnProcessing" class="processing-state">
          <mat-spinner></mat-spinner>
          <div class="processing-text">
            <h4>Analyzing Risk Factors...</h4>
            <p>Our AI model is evaluating account patterns, transaction history, and fraud indicators</p>
          </div>
        </div>

        <div *ngIf="annResults && !isAnnProcessing" class="risk-results">
          <div class="risk-score-display">
            <div class="risk-gauge" [ngClass]="getRiskColor(annResults.confidenceScore)">
              <div class="score-value">{{ (annResults.confidenceScore * 100) | number:'1.0-0' }}%</div>
              <div class="score-label">Risk Score</div>
            </div>
            
            <div class="risk-details">
              <h3>{{ getRiskLevel(annResults.confidenceScore) }} Risk Level</h3>
              <p>Based on AI analysis of multiple risk factors</p>
              <mat-chip [color]="getRiskColor(annResults.confidenceScore)">
                {{ getRiskLevel(annResults.confidenceScore) }} Risk - {{ (annResults.confidenceScore * 100) | number:'1.0-0' }}%
              </mat-chip>
            </div>
          </div>

          <div class="risk-factors">
            <h4>Risk Factors Analyzed</h4>
            <div class="factors-list">
              <div *ngFor="let factor of annResults.factors" class="factor-item">
                <div class="factor-info">
                  <span class="factor-name">{{ factor.factor }}</span>
                  <span class="factor-description">{{ factor.description }}</span>
                </div>
                <div class="factor-weight">
                  <mat-progress-bar 
                    mode="determinate" 
                    [value]="factor.weight * 100"
                    [color]="getRiskColor(factor.weight)">
                  </mat-progress-bar>
                  <span class="weight-value">{{ (factor.weight * 100) | number:'1.0-0' }}%</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div *ngIf="!annResults && !isAnnProcessing" class="ann-prompt">
          <div class="prompt-content">
            <mat-icon>psychology</mat-icon>
            <div class="prompt-text">
              <h4>AI Risk Assessment Available</h4>
              <p>Fill in account details to enable AI-powered fraud risk analysis</p>
            </div>
          </div>
          <button 
            type="button" 
            mat-raised-button 
            color="primary"
            (click)="runAnnAnalysis()"
            [disabled]="!reportForm.get('accountNumber')?.value">
            <mat-icon>analytics</mat-icon>
            Run Risk Analysis
          </button>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Form Actions -->
    <div class="form-actions">
      <button 
        type="button" 
        mat-button 
        color="warn"
        (click)="resetForm()"
        [disabled]="isSubmitting">
        <mat-icon>refresh</mat-icon>
        Reset Form
      </button>
      
      <button 
        type="submit" 
        mat-raised-button 
        color="primary"
        [disabled]="reportForm.invalid || isSubmitting">
        <mat-spinner diameter="20" *ngIf="isSubmitting" class="button-spinner"></mat-spinner>
        <mat-icon *ngIf="!isSubmitting">send</mat-icon>
        {{ isSubmitting ? 'Submitting Report...' : 'Submit Fraud Report' }}
      </button>
    </div>
  </form>
</div>